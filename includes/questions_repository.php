<?php
if (!function_exists('getDefaultQuizQuestions')) {
    function getDefaultQuizQuestions(): array
    {
        return [
            [
                ['label' => 'D', 'text' => 'Pewny siebie, Samodzielny, Zorientowany na cel, Ceni autonomię'],
                ['label' => 'C', 'text' => 'Zdyscyplinowany, Systematyczny, Sprawny, Opanowany'],
                ['label' => 'S', 'text' => 'Odpowiedzialny, Godny zaufania, Można na nim polegać, Punktualny'],
                ['label' => 'I', 'text' => 'Ekspresyjny, Okazujący uczucia, Wyrażający się otwarcie, Gestykulujący'],
            ],
            [
                ['label' => 'I', 'text' => 'Spontaniczny, Działa bez ścisłego planu, Nieuporządkowany, Chaotyczny'],
                ['label' => 'S', 'text' => 'Nieśmiały, Wrażliwy, Spokojny, Nie lubi być w centrum uwagi'],
                ['label' => 'C', 'text' => 'Trzyma się ustalonych zasad, Nieugięty, Uporządkowany, Czepia się drobiazgów'],
                ['label' => 'D', 'text' => 'Dominujący, Przejmujący inicjatywę, Stanowczy, Nierefleksyjny'],
            ],
            [
                ['label' => 'C', 'text' => 'Skrupulatny, Systematyczny, Dba o porządek, Zorganizowany'],
                ['label' => 'S', 'text' => 'Opiekuńczy, Pomocny, Dobry słuchacz, Wyrozumiały'],
                ['label' => 'I', 'text' => 'Kreatywny, Oryginalny  Ma dobrą intuicję, Pomysłowy'],
                ['label' => 'D', 'text' => 'Produktywny, Ambitny, Dążący do celu, Skuteczny'],
            ],
            [
                ['label' => 'S', 'text' => 'Uparty, Nie rezygnuje, Nonkonformista, Odporny na wpływ'],
                ['label' => 'C', 'text' => 'Perfekcyjny, Dąży do doskonałości, Dba o szczegóły, Pedantyczny'],
                ['label' => 'D', 'text' => 'Kieruje się logiką, Lekceważy emocje innych, Opanowany, Dumny'],
                ['label' => 'I', 'text' => 'Impulsywny, Działający szybko, Energiczny, Bez hamulców'],
            ],
            [
                ['label' => 'S', 'text' => 'Ciepły, Serdeczny, Życzliwy, Łagodny'],
                ['label' => 'I', 'text' => 'Entuzjastyczny,  Optymistyczny, Zaangażowany, Inspirujący'],
                ['label' => 'D', 'text' => 'Dzielny, Zdeterminowany, Śmiały, Gotowy na wyzwania'],
                ['label' => 'C', 'text' => 'Dokładny, Ostrożny, Precyzyjny, Dąży do perfekcji'],
            ],
            [
                ['label' => 'C', 'text' => 'Nietowarzyski, Niekontaktowy, Skryty, Zamknięty w sobie'],
                ['label' => 'D', 'text' => 'Niewdzięczny, Niedbały o innych, Nieczuły, Nietaktowny'],
                ['label' => 'I', 'text' => 'Egocentryczny, Zagadujący na śmierć, Ślepy na innych, Pochłonięty sobą'],
                ['label' => 'S', 'text' => 'Bierny, Uległy, Nieasertywny, Nieagresywny'],
            ],
            [
                ['label' => 'I', 'text' => 'Rozmowny, Ekspresyjny, Towarzyski, Przyjazny'],
                ['label' => 'D', 'text' => 'Asertywny, Konkretny, Podejmujący decyzje, Działający'],
                ['label' => 'C', 'text' => 'Analityczny, Badający, Skrupulatny, Oceniający'],
                ['label' => 'S', 'text' => 'Lojalny, Niezawodny, Wspierający, Stały'],
            ],
            [
                ['label' => 'D', 'text' => 'Komenderujący, Mocny, Arogancki, Dogmatyczny'],
                ['label' => 'I', 'text' => 'Niespokojny, Niecierpliwy, Nakręcony, Nie potrafi się zrelaksować'],
                ['label' => 'S', 'text' => 'Powolny, Spokojny, Działa we własnym tempie, Zwlekający'],
                ['label' => 'C', 'text' => 'Zatroskany, Ostrożny, Pełen obaw, Zmartwiony'],
            ],
            [
                ['label' => 'D', 'text' => 'Konkretny, Pewny siebie, Zdecydowany, Mocno osadzony'],
                ['label' => 'C', 'text' => 'Krytycznie myślący, Właściwie analizuję, Dokładny, Precyzyjny'],
                ['label' => 'S', 'text' => 'Przyjazny, Sympatyczny, Miły, Pogodny'],
                ['label' => 'I', 'text' => 'Rozrywkowy, Żywy, Zabawny, Pełen humoru'],
            ],
            [
                ['label' => 'I', 'text' => 'Niestały, Nieodpowiedzialny, Nie można na nim polegać, Niepunktualny'],
                ['label' => 'S', 'text' => 'Zależny, Polega na innych, Niepewny siebie, Chwiejny'],
                ['label' => 'C', 'text' => 'Surowy, Narzuca reguły, Niecierpliwy, Karzący'],
                ['label' => 'D', 'text' => 'Nietaktowny, Nieokrzesany, Niedelikatny, Depczący po odciskach'],
            ],
            [
                ['label' => 'C', 'text' => 'Planujący, Bada za i przeciw, Precyzyjny, Rozważny'],
                ['label' => 'S', 'text' => 'Godny zaufania, Można na nim polegać, Uczciwy, Lojalny'],
                ['label' => 'I', 'text' => 'Otwarty, Szczery, Komunikatywny, Ekspresyjny'],
                ['label' => 'D', 'text' => 'Śmiały, Odważny, Działający z rozmachem, Nieustraszony'],
            ],
            [
                ['label' => 'S', 'text' => 'Niezdecydowany, Zbierający dane, Niekonkretny, Wahający się'],
                ['label' => 'C', 'text' => 'Ostrożny, Nieufny, Dokładny, Rozważny'],
                ['label' => 'D', 'text' => 'Twardy, Logiczny, Nieugięty, Zdeterminowany'],
                ['label' => 'I', 'text' => 'Niekonsekwentny, Nielogiczny, Pełen sprzeczności, Kreatywny'],
            ],
            [
                ['label' => 'S', 'text' => 'Tolerancyjny, Cierpliwy, Szanujący, Akceptujący'],
                ['label' => 'I', 'text' => 'Wszechstronny, Elastyczny, Twórczy, Pomysłowy'],
                ['label' => 'D', 'text' => 'Zdecydowany, Ambitny, Stanowczy, Nieustępliwy'],
                ['label' => 'C', 'text' => 'Precyzyjny, Dokładny, Konkretny, Odpowiedzialny'],
            ],
            [
                ['label' => 'C', 'text' => 'Drażliwy, Szybko się obraża, Wrażliwy, Łatwo urazić'],
                ['label' => 'D', 'text' => 'Dominujący, Nieelastyczny, Agresywny, Rywalizacyjny'],
                ['label' => 'I', 'text' => 'Ekspresyjny, Gaduła, Mówi, co ma na myśli, Asertywny'],
                ['label' => 'S', 'text' => 'Wycofany, Łatwy w kontakcie, Bierny, Niegroźny'],
            ],
            [
                ['label' => 'I', 'text' => 'Wspaniałomyślny, Niesamolubny, Potrafi dawać, Lubi się dzielić'],
                ['label' => 'D', 'text' => 'Bezpośredni, Przywódczy, Zdecydowany, Silny'],
                ['label' => 'C', 'text' => 'Spostrzegawczy, Otwarty na informacje, Obserwujący, Rozróżniający'],
                ['label' => 'S', 'text' => 'Tolerancyjny, Cierpliwy, Łatwo się przystosowuje, Dostosowujący się'],
            ],
            [
                ['label' => 'D', 'text' => 'Kontrolujący, Manipulacyjny, Wymuszający, Dyrygujący'],
                ['label' => 'I', 'text' => 'Nadgorliwy, Pochopny, Impulsywny, Niespokojny'],
                ['label' => 'S', 'text' => 'Uczuciowy, Wrażliwy, Głęboko przeżywający, Delikatny'],
                ['label' => 'C', 'text' => 'Nieufny, Podejrzliwy, Uważny, Nastawiony obronnie'],
            ],
        ];
    }
}

if (!function_exists('ensureQuizQuestionsTable')) {
    function ensureQuizQuestionsTable(mysqli $conn): void
    {
        $sql = "CREATE TABLE IF NOT EXISTS quiz_questions (
            id INT AUTO_INCREMENT PRIMARY KEY,
            question_order INT NOT NULL,
            options_json LONGTEXT NOT NULL,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
            UNIQUE KEY uq_question_order (question_order)
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4";

        $conn->query($sql);
    }
}

if (!function_exists('seedQuizQuestionsIfEmpty')) {
    function seedQuizQuestionsIfEmpty(mysqli $conn): void
    {
        ensureQuizQuestionsTable($conn);

        $countResult = $conn->query('SELECT COUNT(*) as total FROM quiz_questions');
        $row = $countResult ? $countResult->fetch_assoc() : null;
        if (!$row || (int) $row['total'] > 0) {
            return;
        }

        $defaultQuestions = getDefaultQuizQuestions();
        $stmt = $conn->prepare('INSERT INTO quiz_questions (question_order, options_json) VALUES (?, ?)');

        foreach ($defaultQuestions as $index => $options) {
            $optionsSanitized = array_map(fn($opt) => [
                'label' => $opt['label'],
                'text' => trim($opt['text']),
            ], $options);

            $json = json_encode($optionsSanitized, JSON_UNESCAPED_UNICODE);
            $order = $index + 1;
            $stmt->bind_param('is', $order, $json);
            $stmt->execute();
        }

        $stmt->close();
    }
}

if (!function_exists('fetchQuizQuestions')) {
    function fetchQuizQuestions(mysqli $conn, ?string $search = null, ?int $limit = null, ?int $offset = null): array
    {
        ensureQuizQuestionsTable($conn);

        $conditions = [];
        $params = [];
        $types = '';

        if ($search) {
            $conditions[] = 'options_json LIKE ?';
            $params[] = '%' . $conn->real_escape_string($search) . '%';
            $types .= 's';
        }

        $where = $conditions ? ('WHERE ' . implode(' AND ', $conditions)) : '';
        $order = 'ORDER BY question_order ASC';

        $limitClause = '';
        if ($limit !== null && $offset !== null) {
            $limitClause = ' LIMIT ? OFFSET ?';
            $types .= 'ii';
            $params[] = $limit;
            $params[] = $offset;
        }

        $sql = "SELECT id, question_order, options_json FROM quiz_questions {$where} {$order}{$limitClause}";

        if ($params) {
            $stmt = $conn->prepare($sql);
            $stmt->bind_param($types, ...$params);
            $stmt->execute();
            $result = $stmt->get_result();
        } else {
            $result = $conn->query($sql);
        }

        $questions = [];
        while ($row = $result->fetch_assoc()) {
            $decoded = json_decode($row['options_json'], true) ?? [];
            $questions[] = [
                'id' => (int) $row['id'],
                'order' => (int) $row['question_order'],
                'options' => $decoded,
            ];
        }

        if (isset($stmt)) {
            $stmt->close();
        }

        return $questions;
    }
}

if (!function_exists('countQuizQuestions')) {
    function countQuizQuestions(mysqli $conn, ?string $search = null): int
    {
        ensureQuizQuestionsTable($conn);

        if ($search) {
            $stmt = $conn->prepare('SELECT COUNT(*) as total FROM quiz_questions WHERE options_json LIKE ?');
            $like = '%' . $conn->real_escape_string($search) . '%';
            $stmt->bind_param('s', $like);
            $stmt->execute();
            $result = $stmt->get_result();
            $row = $result->fetch_assoc();
            $stmt->close();
            return (int) ($row['total'] ?? 0);
        }

        $result = $conn->query('SELECT COUNT(*) as total FROM quiz_questions');
        $row = $result->fetch_assoc();
        return (int) ($row['total'] ?? 0);
    }
}

if (!function_exists('upsertQuizQuestion')) {
    function upsertQuizQuestion(mysqli $conn, array $data): void
    {
        ensureQuizQuestionsTable($conn);

        $optionsJson = json_encode($data['options'], JSON_UNESCAPED_UNICODE);

        if (!empty($data['id'])) {
            $stmt = $conn->prepare('UPDATE quiz_questions SET question_order = ?, options_json = ? WHERE id = ?');
            $stmt->bind_param('isi', $data['order'], $optionsJson, $data['id']);
            $stmt->execute();
            $stmt->close();
            return;
        }

        $stmt = $conn->prepare('INSERT INTO quiz_questions (question_order, options_json) VALUES (?, ?)');
        $stmt->bind_param('is', $data['order'], $optionsJson);
        $stmt->execute();
        $stmt->close();
    }
}

if (!function_exists('deleteQuizQuestion')) {
    function deleteQuizQuestion(mysqli $conn, int $id): void
    {
        ensureQuizQuestionsTable($conn);
        $stmt = $conn->prepare('DELETE FROM quiz_questions WHERE id = ?');
        $stmt->bind_param('i', $id);
        $stmt->execute();
        $stmt->close();
    }
}

if (!function_exists('buildOptionsPayload')) {
    function buildOptionsPayload(array $source, array $order = ['D', 'I', 'S', 'C']): array
    {
        $options = [];
        foreach ($order as $label) {
            $key = 'option_' . strtolower($label);
            if (!isset($source[$key])) {
                continue;
            }
            $options[] = [
                'label' => $label,
                'text' => trim($source[$key]),
            ];
        }

        return $options;
    }
}
